# Knowledge Evolution Suggestions

> **WARNING:** These are proposals only. Do NOT apply without human review.
> Generated by R-Knowledge agent during pipeline execution.

## Suggestions

### 1. [instruction-update] Fix Residual "merges" Language in Summary-Level References

- **Target file:** `.github/agents/orchestrator.agent.md`
- **Change type:** Update
- **Rationale:** Phase 1 corrected all 8 merge step bodies and 5 "via `memory` tool" references to use subagent delegation language. However, 3 summary-level references still use bare "merges" implying direct orchestrator file action. CT-Maintainability (iter 3) flagged this as Low severity. Aligning them eliminates the last inconsistency between summary and detailed merge wording.
- **Diff:**
  ```diff
  # Global Rule 6 (L39)
  - orchestrator reads the agent's `memory/<agent>.mem.md` and merges Key Findings, Decisions, and Artifact Index into `memory.md`.
  + orchestrator reads the agent's `memory/<agent>.mem.md` and dispatches a subagent to merge Key Findings, Decisions, and Artifact Index into `memory.md`.

  # Memory Lifecycle Table — Merge row (L503)
  - Orchestrator reads `memory/<agent>.mem.md`, merges Key Findings, Decisions, and Artifact Index into `memory.md`.
  + Orchestrator reads `memory/<agent>.mem.md`, dispatches a subagent to merge Key Findings, Decisions, and Artifact Index into `memory.md`.

  # Memory Lifecycle Table — Merge (post-mortem) row (~L510)
  - Read `memory/post-mortem.mem.md`, merge into `memory.md`
  + Read `memory/post-mortem.mem.md`, dispatch a subagent to merge into `memory.md`
  ```
- **Risk assessment:** Low — wording-only change, same pattern as the 8 merge step corrections already applied in Phase 1.

### 2. [instruction-update] Fix Stale Dispatch Patterns Path

- **Target file:** `.github/agents/orchestrator.agent.md`
- **Change type:** Update
- **Rationale:** Line 97 references `NewAgentsAndPrompts/dispatch-patterns.md` — a path from a prior directory structure. The actual file is `.github/agents/dispatch-patterns.md`. Pre-existing bug identified by CT-Security (iter 3, Low). The inline Pattern A/B summaries mean the broken link has no behavioral impact, but it's incorrect documentation.
- **Diff:**
  ```diff
  # Cluster Dispatch Patterns section (L97)
  - > Patterns A and B full definitions: `NewAgentsAndPrompts/dispatch-patterns.md`. Read this file when detailed error handling or edge case logic is needed.
  + > Patterns A and B full definitions: `.github/agents/dispatch-patterns.md`. Read this file when detailed error handling or edge case logic is needed.
  ```
- **Risk assessment:** Low — path correction only. No behavioral change.

### 3. [instruction-update] Align Orchestrator Expectations Table "merges" Language

- **Target file:** `.github/agents/orchestrator.agent.md`
- **Change type:** Update
- **Rationale:** The Orchestrator Expectations table (L477–L492) has 8 rows saying "Orchestrator reads memory and merges" in the "On DONE (or equivalent)" column. Same root cause as Suggestion 1 — bare "merges" implies direct file action. Table cells are naturally terse, so this is lower priority than Suggestion 1, but should be aligned for consistency.
- **Diff:**
  ```diff
  # Orchestrator Expectations table rows (L477-L492)
  - Orchestrator reads memory and merges
  + Orchestrator reads memory and dispatches merge
  ```
  (Apply to all 8 applicable rows in the table.)
- **Risk assessment:** Low — table cell wording change. Reduces ambiguity without changing behavior.

### 4. [skill-update] Add Text-Match Verification Guidance to Implementer

- **Target file:** `.github/agents/implementer.agent.md`
- **Change type:** Update (Operating Rules section)
- **Rationale:** All 4 implementers in this feature used a consistent pattern: read the target section first to confirm the design's "Current" text matches before applying edits. This is especially important for prompt-only tasks where line numbers drift. Codifying this in the implementer's Operating Rules would make the pattern explicit for future tasks.
- **Diff:**
  ```diff
  # Operating Rules section (add after context-efficient reading rule)
  + - **Edit verification for prompt/doc tasks:** Before applying text replacements to prompt or documentation files, read the target section and verify that the design's "Current" text matches the actual file content. Match on text content, not line numbers — line numbers may drift between design authoring and implementation.
  ```
- **Risk assessment:** Low — additive guidance. Does not constrain existing behavior.

### 5. [pattern-capture] Document Triple-Layered Tool Enforcement Pattern

- **Target file:** `.github/instructions/tool-enforcement.instructions.md` (new file — if instructions directory is adopted)
- **Change type:** Add
- **Rationale:** The orchestrator's tool restriction uses a triple-layer enforcement pattern (YAML `tools:` + Operating Rule prose + Anti-Drift Anchor) that other high-risk agents could adopt. Documenting this pattern ensures consistency if future agents need tool restrictions.
- **Diff:**
  ```diff
  + # Tool Enforcement Pattern
  +
  + When restricting an agent's tool access, use three complementary enforcement layers:
  +
  + 1. **YAML `tools:` frontmatter** — Machine-readable declaration. Advisory-only enforcement by VS Code runtime.
  + 2. **Operating Rule prose** — Primary LLM enforcement. Lists allowed tools AND prohibited tools with rationale.
  + 3. **Anti-Drift Anchor** — End-of-prompt reinforcement. Repeats prohibited tools with justification.
  +
  + All three layers MUST list identical tool sets. Inconsistency between layers creates confusion.
  +
  + ## When to Apply
  +
  + - Agents that should not write files (orchestrator pattern)
  + - Agents that should not discover/search (read-only pattern)
  + - Agents with elevated risk if tools are misused
  ```
- **Risk assessment:** Low — new documentation file. No behavioral change.

### 6. [pattern-capture] Document Memory Tool Disambiguation Requirement

- **Target file:** `.github/instructions/memory-disambiguation.instructions.md` (new file — if instructions directory is adopted)
- **Change type:** Add
- **Rationale:** The `memory` tool / `memory.md` conflation produced 5 pre-existing bugs. Any future agent that references both the VS Code `memory` tool and pipeline `memory.md` should include explicit disambiguation. This instruction codifies the lesson learned.
- **Diff:**
  ```diff
  + # Memory Tool Disambiguation
  +
  + The VS Code `memory` tool is a cross-session codebase knowledge store. It does NOT create or modify pipeline files.
  +
  + Pipeline memory files (`memory.md`, `memory/<agent>.mem.md`) are created and modified by subagents via `runSubagent`.
  +
  + ## Rule
  +
  + Any agent prompt that mentions both the `memory` tool and pipeline memory files MUST include
  + an explicit disambiguation statement in its Operating Rules or Global Rules section:
  +
  + > The `memory` tool is VS Code's cross-session knowledge store — it does NOT create or modify pipeline files.
  +
  + Do NOT use phrases like "via `memory` tool" or "using `memory` tool" when describing pipeline file operations.
  ```
- **Risk assessment:** Low — new documentation file. Prevents recurrence of a known anti-pattern.

### 7. [pattern-capture] Document Same-File Sequencing Requirement for Wave Planning

- **Target file:** `.github/agents/planner.agent.md` (or `.github/instructions/wave-planning.instructions.md`)
- **Change type:** Update or Add
- **Rationale:** Tasks 01 and 02 both edited `orchestrator.agent.md` and were correctly sequenced into different waves to avoid concurrent-edit conflicts. This pattern should be explicit in the planner's guidance — if the planner doesn't know about same-file conflicts, parallel dispatch of same-file tasks could cause edit failures.
- **Diff:**
  ```diff
  # In planner Operating Rules or Wave Planning section
  + - **Same-file sequencing:** If multiple tasks edit the same file, they MUST be placed in sequential waves regardless of logical independence. Concurrent edits to the same file cause `oldString` match failures when earlier tasks modify content near later tasks' edit points.
  ```
- **Risk assessment:** Low — additive planning guidance.

## Rejected Suggestions

None. No suggestions were identified that would weaken safety constraints, error handling, or verification steps.
