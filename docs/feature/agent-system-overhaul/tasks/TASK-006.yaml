agent_output:
  agent: "planner"
  schema_version: "1.0"
  payload:
    task_id: "TASK-006"
    task_type: "documentation"
    title: "Create SQL Templates Reference Doc"
    description: |
      Create NewAgents/.github/agents/sql-templates.md โ the consolidated SQL template
      reference document. This is the CRITICAL path for addressing security findings
      SEC-1 (SQL injection) and SEC-2 (command injection), correctness findings CORR-1
      (evidence gate scope), CORR-2 (EG-6 false positives), CORR-3 (quoting convention),
      and architecture finding ARCH-2 (schema evolution).

      Content outline (~160 lines):
      - ยง0 SQL Sanitization Functions: MANDATORY sql_escape() โ single-quote doubling,
           null byte stripping, length truncation. Shell injection prevention via stdin
           piping to sqlite3 (echo "SQL" | sqlite3 db). Self-verification checklist:
           "Did I apply sql_escape() to every free-text field?"
      - ยง1 Database Initialization DDL: verification-ledger.db with 4 tables (anvil_checks,
           pipeline_telemetry, artifact_evaluations, instruction_updates). WAL mode +
           busy_timeout=5000 + PRAGMA integrity_check for existing DBs.
      - ยง2 anvil_checks INSERT Template: 15-column INSERT with CHECK constraints.
           EXPLICIT QUOTING CONVENTION (CORR-3): NULL (unquoted) when absent, 'value'
           (single-quoted) when present. All free-text fields use sql_escape().
      - ยง3 pipeline_telemetry INSERT Template: Orchestrator-only, after each dispatch.
      - ยง4 artifact_evaluations INSERT Template: Phase 1 agents. CHECK constraints on
           artifact_path (no .. or / prefix per SEC-6). LENGTH limits on free-text fields.
      - ยง5 instruction_updates INSERT Template: Knowledge Agent only. file_path CHECK
           constraint (SEC-6): file_path LIKE '.github/instructions/%' OR
           file_path = '.github/copilot-instructions.md'.
      - ยง6 Evidence Gate SELECT Queries: 6 templated queries with {run_id}, {task_id},
           {scope}, {round} placeholders. ALL queries include task_id filter (CORR-1).
           EG-6 majority approval uses subquery: SELECT COUNT(*) FROM (SELECT instance
           FROM anvil_checks WHERE ... GROUP BY instance HAVING COUNT(CASE WHEN
           verdict != 'approve' THEN 1 END) = 0) (CORR-2).
           Check_names are scope-qualified: review-{scope}-security, review-{scope}-architecture,
           review-{scope}-correctness.
      - ยง7 Knowledge Agent Aggregation Queries: Telemetry summary, evaluation summary,
           instruction history.
      - ยง8 SQLITE_BUSY Retry Pattern: 3x retry, exponential backoff (1s, 2s, 4s), WAL note.
           Cross-reference to global-operating-rules.md ยง3.
      - ยง9 SQLite Schema Evolution Strategy (ARCH-2): ALTER TABLE ADD COLUMN as safe
           additive change, enum expansion via table recreation pattern, schema_meta version
           tracking table, migration ownership documentation.

      This is the highest-priority Wave 2 task. All agent modification tasks that write SQL
      depend on this being correct.
    risk_classification: "๐ก"
    wave: 2
    dependencies: ["TASK-002"]
    estimated_lines_changed: 160
    affected_files:
      - path: "NewAgents/.github/agents/sql-templates.md"
        action: "create"
    addresses_frs: ["FR-5", "FR-6", "FR-10", "FR-13", "FR-14"]
    relevant_context:
      - file: "docs/feature/agent-system-overhaul/design-output.yaml"
        sections:
          [
            "payload.file_inventory[path='NewAgents/.github/agents/sql-templates.md']",
            "payload.shared_documents[path='NewAgents/.github/agents/sql-templates.md']",
          ]
        reason: "File description and ยง0-ยง9 content outline with sanitization additions"
      - file: "docs/feature/agent-system-overhaul/design-output.yaml"
        sections: ["payload.sqlite_schemas"]
        reason: "Full DDL for all 4 tables (anvil_checks, pipeline_telemetry, artifact_evaluations, instruction_updates) with CHECK constraints and indexes"
      - file: "docs/feature/agent-system-overhaul/design-output.yaml"
        sections: ["payload.review_design.evidence_gate_queries"]
        reason: "Updated evidence gate SQL with task_id filters and scope-qualified check_names"
      - file: "docs/feature/agent-system-overhaul/review-verdicts/design-security.yaml"
        sections:
          [
            "findings[id='SEC-1']",
            "findings[id='SEC-2']",
            "findings[id='SEC-6']",
          ]
        reason: "SEC-1: sql_escape() requirement. SEC-2: shell injection prevention via stdin piping. SEC-6: file_path CHECK constraints."
      - file: "docs/feature/agent-system-overhaul/review-verdicts/design-correctness.yaml"
        sections:
          [
            "findings[id='CORR-1']",
            "findings[id='CORR-2']",
            "findings[id='CORR-3']",
          ]
        reason: "CORR-1: task_id filter in evidence gates. CORR-2: EG-6 subquery fix. CORR-3: quoting convention."
      - file: "docs/feature/agent-system-overhaul/review-verdicts/design-architecture.yaml"
        sections: ["findings[id='ARCH-2']"]
        reason: "ARCH-2: SQLite schema evolution strategy required in ยง9"
      - file: "docs/feature/agent-system-overhaul/design-output.yaml"
        sections: ["payload.decisions[id='D-1']", "payload.decisions[id='D-8']"]
        reason: "D-1: database consolidation rationale. D-8: 3 category-specific INSERTs per reviewer."
    acceptance_criteria:
      - "sql-templates.md exists with 10 sections (ยง0-ยง9)"
      - "ยง0 defines mandatory sql_escape() with single-quote doubling, null byte stripping, length truncation"
      - "ยง0 defines shell injection prevention via stdin piping (echo 'SQL' | sqlite3 db)"
      - "ยง0 includes self-verification checklist item for SQL-writing agents"
      - "ยง1 DDL creates all 4 tables with CHECK constraints matching design-output.yaml sqlite_schemas"
      - "ยง2 documents explicit quoting convention: NULL unquoted, 'value' quoted (CORR-3)"
      - "ยง4 artifact_evaluations INSERT includes CHECK on artifact_path (no .. or / prefix) (SEC-6)"
      - "ยง5 instruction_updates INSERT includes CHECK on file_path (SEC-6)"
      - "ยง6 ALL 6 evidence gate queries include task_id filter (CORR-1)"
      - "ยง6 EG-6 uses subquery with HAVING COUNT(CASE WHEN verdict!='approve' THEN 1 END)=0 (CORR-2)"
      - "ยง9 includes SQLite schema evolution strategy (ALTER TABLE, enum expansion, version tracking) (ARCH-2)"
      - "File is โค160 lines"
    verification_tier: "Standard"
